{% extends 'base.html' %}
{% block content %}

<script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
<!-- 
<script> 
    let map

    function initMap(){

        var locations = {{ locations|safe }};
        var firstLocation = locations[0]
        var infoWindow = []

        map = new google.maps.Map(document.getElementById("map"),{
            center: { lat: firstLocation.lat, lng: firstLocation.lng }, 
            zoom: 4,
        }
        );

        locations.forEach(function (location){
            var marker = new google.maps.Marker({
                position: {lat: location.lat, lng: location.lng}, 
                map: map, 
                title: location.name
            });

            var infowindow = new google.maps.InfoWindow({
                content: location.name, 
            });

            infoWindow.push(infowindow)

            marker.addListener('click', function(){
                infoWindow.forEach(function(iw){
                    iw.close();
                });

                infowindow.open(map, marker)
            });
        });
    }

    window.initMap = initMap

</script> -->
<!-- <script>
  let map

function initMap(){
    var locations = {{ locations|safe }};
    var firstLocation = locations[0];
    var infoWindow = [];

    map = new google.maps.Map(document.getElementById("map"),{
        center: { lat: firstLocation.lat, lng: firstLocation.lng }, 
        zoom: 4,
    });

    locations.forEach(function (location){
        var marker = new google.maps.Marker({
            position: {lat: location.lat, lng: location.lng}, 
            map: map, 
            title: location.name,
            icon: getPinColor(location.color)  
        });

        var infowindow = new google.maps.InfoWindow({
            content: location.name, 
        });

        infoWindow.push(infowindow);

        marker.addListener('click', function(){
            infoWindow.forEach(function(iw){
                iw.close();
            });

            infowindow.open(map, marker);
        });
    });
}

function getPinColor(color) {
    // Define your pin colors based on the color property
    switch(color) {
        case 'red':
            return 'http://maps.google.com/mapfiles/ms/icons/red-dot.png';
        case 'blue':
            return 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png';
        case 'green':
            return 'http://maps.google.com/mapfiles/ms/icons/green-dot.png';
        // Add more cases for additional colors
        default:
            return 'http://maps.google.com/mapfiles/ms/icons/red-dot.png'; // Default color
    }
}

function updateMapData() {
    
    fetch('')  
        .then(response => response.json())
        .then(data => {
            
            locations = data;

            // Remove existing markers
            infoWindow.forEach(iw => iw.close());
            infoWindow = [];

            // Add new markers
            locations.forEach(function(location) {
                // Your existing marker and info window creation code...
            });
        })
        .catch(error => console.error('Error fetching data:', error));
}

window.initMap = initMap;
</script> -->

<!-- <script>
  let map;
  let infoWindow = [];
  let locations = {{ locations|safe }};
  
  function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: 37.7749, lng: -122.4194 }, // Set initial center coordinates
          zoom: 4,
      });
  
      updateMapData();
  
      setInterval(updateMapData, 10000);
  }
  
  function updateMapData() {
      fetch('/getUpdatedLocations/')  // Replace with the actual URL to fetch updated data
          .then(response => response.json())
          .then(data => {
              locations = data;
  
              infoWindow.forEach(iw => iw.close());
              infoWindow = [];
  
              locations.forEach(function(location) {
                  const marker = new google.maps.Marker({
                      position: { lat: location.lat, lng: location.lng },
                      map: map,
                      title: location.name,
                      icon: getPinColor(location.color),
                  });
  
                  const infowindow = new google.maps.InfoWindow({
                      content: location.name,
                  });
  
                  infoWindow.push(infowindow);
  
                  marker.addListener('click', function() {
                      infoWindow.forEach(iw => iw.close());
                      infowindow.open(map, marker);
                  });
              });
          })
          .catch(error => console.error('Error fetching data:', error));
  }
  
  function getPinColor(color) {
      switch(color) {
          case 'red':
              return 'http://maps.google.com/mapfiles/ms/icons/red-dot.png';
          case 'blue':
              return 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png';
          case 'green':
              return 'http://maps.google.com/mapfiles/ms/icons/green-dot.png';
          default:
              return 'http://maps.google.com/mapfiles/ms/icons/red-dot.png';
      }
  }
  
  window.initMap = initMap;
  </script> -->
  <script>
    let map;
    let infoWindow = [];
    let locations = {{ locations|safe }};
    
    function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
            center: { lat: 37.7749, lng: -122.4194 }, // Set initial center coordinates
            zoom: 4,
        });
    
        updateMapData();
    
        setInterval(updateMapData, 30000000);
        setInterval(updateCardData, 30000);
    }
    
    function updateMapData() {
        fetch('http://127.0.0.1:8000/mechanic/update_map')  // Replace with the actual URL to fetch updated data
            .then(response => response.json())
            .then(data => {
                locations = data;
    
                infoWindow.forEach(iw => iw.close());
                infoWindow = [];
    
                locations.forEach(function(location) {
                    const marker = new google.maps.Marker({
                        position: { lat: location.lat, lng: location.lng },
                        map: map,
                        title: location.name,
                        icon: getPinColor(location.color),
                    });
    
                    const infowindow = new google.maps.InfoWindow({
                        content: location.name,
                    });
    
                    infoWindow.push(infowindow);
    
                    marker.addListener('click', function() {
                        infoWindow.forEach(iw => iw.close());
                        infowindow.open(map, marker);
                    });
                });
            })
            .catch(error => console.error('Error fetching data:', error));
    }
    
    function getPinColor(color) {
        switch(color) {
            case 'red':
                return 'http://maps.google.com/mapfiles/ms/icons/red-dot.png';
            case 'blue':
                return 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png';
            case 'green':
                return 'http://maps.google.com/mapfiles/ms/icons/green-dot.png';
            default:
                return 'http://maps.google.com/mapfiles/ms/icons/red-dot.png';
        }
    }
    fetch('http://127.0.0.1:8000/mechanic/get_vehicle_data')
            .then(response => response.json())
            .then(data => renderCards(data))
            .catch(error => console.error('Error fetching data:', error));

        function renderCards(data) {
            const cardContainer = document.getElementById('card-container');

            // Loop through each item in the data
            data.forEach(item => {
                // Create a card for each item
                const card = document.createElement('div');
                card.className = 'card';
                let vat = item.username;
                let url = `/mechanic/display_info/${encodeURIComponent(vat)}`;
                card.innerHTML = `
                    <h2>${item.username}</h2>
                    <p>${item.issue_description}</p>
                    <p>${item.contact}</p>
                    <p>${item.distance}</p>
                    <p>${item.time}</p>

                    <p id="demo"></p>
                   
                    
                    <a href="${url}">View Details</a>
                    <button type="button" class="btn btn-outline-danger" onclick="rejectRequest()">Reject</button>
                `;

                // Append the card to the container
                cardContainer.appendChild(card);
            });
        }
        
        function getLocation(value) {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(value);
            } else {
                x.innerHTML = "Geolocation is not supported by this browser.";
            }
        }
  
        function showPosition(position) {
            x.innerHTML = "Latitude: " + position;
  
            // Send data to Django backend
            fetch('http://127.0.0.1:8000/mechanic/process_request', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    latitude: position
                })
            })
            .then(response => response.json())
            .then(data => console.log(data))
            .catch(error => console.error('Error:', error));
        }
        
        function acceptRequest(selectedCard) {
            // Check if selectedCard is not empty
            if (!selectedCard) {
                console.error('Selected card data is empty.');
                return;
            }
        
            // Logic to handle accepting the request
            console.log('Request accepted:', selectedCard);
        
            // Pass data to the backend and redirect to another page
            passDataToBackend(selectedCard);
        }
        
        // Function to pass data to the backend
        function passDataToBackend(selectedCard) {
            // Extract relevant data from the selectedCard
            const requestData = {
                vehicle_number: selectedCard,
                
                // Add other fields as needed
            };
        
            // Send data to the backend using a POST request
            fetch('http://127.0.0.1:8000/mechanic/process_request', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    vehicle_number: selectedCard,
                })
            })
            .then(response => response.json())
            .then(data => console.log(data))
            .catch(error => console.error('Error:', error));
        }
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    
        function rejectRequest() {
            const card = button.closest('.card');
            card.remove();
        }
    
    window.initMap = initMap;
    </script>
    
  
<div class="pageholder">
    <h2>Welcome, {{ request.session.name }}!</h2>


    <div class="linkholder">
        <div class="mapholder"> 
            <div id="map"> </div>

            <script async
                src="https://maps.googleapis.com/maps/api/js?key={{key}}&callback=initMap">
            </script>

        </div>
        <div>
          <!-- <div class="card-container" id="dynamic-card" style="background-color: #e3f2fd;">
              <h2 id="card-title">Request</h2>
              <p id="card-description">Vehicle Description</p>
              
              <button id="acceptButton" type="button" class="btn btn-outline-success" onclick="acceptRequest()">Accept</button>
              <button id="rejectButton" type="button" class="btn btn-outline-danger" onclick="rejectRequest()">Reject</button>
          </div> -->
          <div id="card-container" style="background-color: #e3f2fd;">
            <!-- Dynamic cards will be added here -->
        </div>
      </div>
        
     </div>


  


</div>
<script>
      function updateEditableText(value) {
        // You can add additional logic here if needed

        console.log("Current text: " + {{ locations|safe }});
    }
</script>
{% endblock %}